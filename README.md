# A Scale-sensitive Heatmap Representation for Multi-person Pose Estimation

## Introduction
Multi-person pose estimation is a challenging vision task that can be seriously affected by keypoint scale variation. Existing heatmap-based approaches are devoted to reducing the effect by optimizing backbone architecture or loss functions, but the problem of an inaccurate heatmap representation with different keypoint scales still exists. We present a scale-sensitive heatmap algorithm to generate reasonable spatial and contextual features for the network to predict more precise coordinates, by systematically considering the <i>standard deviation</i>, <i>truncated radius</i>, and <i>shape</i> of Gaussian kernels. Specifically, the scale-sensitive heatmap algorithm contains three parts: <i>inter-person heatmap</i>, <i>limited-area heatmap</i>, and <i>shape-aware heatmap</i>. The inter-person heatmap allocates different standard deviation for each human instance proportionally calculated by the keypoint-based method, the limited-area heatmap defines the truncated radius to limit the influence area of Gaussian kernels, and the shape-aware heatmap modifies the Gaussian kernels generated by some ellipse-shaped joints. Our scale-sensitive heatmap algorithm outperforms by a considerable margin on the COCO and CrowdPose benchmark datasets. The code and pretrained models are available at https://github.com/ducongju/Scale-sensitive-Heatmap.

## Environment

The code is developed using python 3.6 on Ubuntu 16.04. NVIDIA GPUs are needed. The code is developed and tested using 4 NVIDIA V100 GPU cards for HRNet-W32. Other platforms are not fully tested.

## Quick start

### Prepare the directory

1. Clone this repo, and we'll call the directory that you cloned as ${POSE_ROOT}.

2. Init output(training model output directory) and log(tensorboard log directory) directory:

   ```
   mkdir output
   mkdir log
   mkdir model
   mkdir data
   mkdir vis
   ```

### Download the pretrained models

Download pretrained models and our well-trained models from zoo([Google Drive](https://drive.google.com/drive/folders/1zp0Po0G38xLuQJ8cmOhUTAxDgYmz1UTH?usp=sharing) and make models directory look like this:

    ${POSE_ROOT}
    |-- model
    `-- |-- imagenet
        |   |-- hrnet_w32-36af842e.pth
        `-- rescore
            |-- final_rescore_coco_kpt.pth
            `-- final_rescore_crowd_pose_kpt.pth
    |-- output        
        |-- coco
        |   |-- coco_hrnetw32_scale-sensitive.pth
        	|-- coco_hrnetw32_shape.pth
        	|-- coco_hrnetw32_inter.pth
        |-- crowdpose
        |   |-- crowdpose_hrnetw32_scale-sensitive.pth


### Data preparation

**For COCO data**, please download from [COCO download](http://cocodataset.org/#download), 2017 Train/Val is needed for COCO keypoints training and validation. 
Download and extract them under {POSE_ROOT}/data, and make them look like this:

    ${POSE_ROOT}
    |-- data
    `-- |-- coco
        `-- |-- annotations
            |   |-- person_keypoints_train2017.json
            |   `-- person_keypoints_val2017.json
                `-- image_info_test-dev2017.json
            `-- images
                |-- train2017.zip
                `-- val2017.zip
                `-- test2017.zip

**For CrowdPose data**, please download from [CrowdPose download](https://github.com/Jeff-sjtu/CrowdPose#dataset), Train/Val is needed for CrowdPose keypoints training.
Download and extract them under {POSE_ROOT}/data, and make them look like this:

    ${POSE_ROOT}
    |-- data
    `-- |-- crowdpose
        `-- |-- json
            |   |-- crowdpose_train.json
            |   |-- crowdpose_val.json
            |   |-- crowdpose_trainval.json (generated by tools/crowdpose_concat_train_val.py)
            |   `-- crowdpose_test.json
            `-- images.zip

After downloading data, run `python tools/crowdpose_concat_train_val.py` under `${POSE_ROOT}` to create trainval set.

### Prepare the environment

If you are using SLURM (Simple Linux Utility for Resource Management), then execute:

```
sbatch ready.sh
```

If you like, you can [**prepare the environment step by step**](https://github.com/HRNet/HRNet-Bottom-Up-Pose-Estimation).

### Training and Testing

#### Testing on COCO val2017 dataset without multi-scale test using well-trained pose model

```
python tools/valid.py --cfg experiments/coco/w32/coco_hrnetw32_jnt_scale-sensitive.yaml TEST.MODEL_FILE output/coco/coco_hrnetw32_scale-sensitive.pth
```

#### Testing on COCO val2017 dataset with multi-scale test using well-trained pose model

```
python tools/valid.py --cfg experiments/coco/w32/coco_hrnetw32_jnt_scale-sensitive.yaml TEST.MODEL_FILE output/coco/coco_hrnetw32_scale-sensitive.pth TEST.SCALE_FACTOR 0.5,1,2
```

#### Testing on crowdpose test dataset without multi-scale test using well-trained pose model

```
python tools/valid.py --cfg experiments/crowdpose/w32/crowdpose_hrnetw32_scale-sensitive.yaml TEST.MODEL_FILE output/crowdpose/crowdpose_hrnetw32_scale-sensitive.pth
```

#### Testing on crowdpose test dataset with multi-scale test using well-trained pose model

```
python tools/valid.py --cfg experiments/crowdpose/w32/crowdpose_hrnetw32_scale-sensitive.yaml TEST.MODEL_FILE output/crowdpose/crowdpose_hrnetw32_scale-sensitive.pth TEST.SCALE_FACTOR 0.5,1,2
```

#### Training on COCO train2017 dataset

```
python tools/train.py --cfg experiments/coco/w32/coco_hrnetw32_scale-sensitive.yaml OUTPUT_DIR 'output/minecoco'
```

#### Training on Crowdpose trainval dataset

```
python tools/train.py --cfg experiments/crowdpose/w32/crowdpose_hrnetw32_scale-sensitive.yaml OUTPUT_DIR 'output/minecrowdpose'
```

#### Using video demo
```
python tools/inference_video.py --cfg experiments/inference_demo_coco.yaml --videoFile vis/multi_people.mp4 --outputDir vis --visthre 0.3 TEST.MODEL_FILE output/coco/coco_hrnetw32_scale-sensitive.pth

python tools/inference_video.py --cfg experiments/inference_demo_crowdpose.yaml --videoFile vis/multi_people.mp4 --outputDir vis --visthre 0.3 TEST.MODEL_FILE output/crowdpose/crowdpose_hrnetw32_scale-sensitive.pth
```

The above command will create a video under *vis* directory and a lot of pose image under *vis/pose* directory. 

#### Using image demo
```
python tools/inference_image.py --cfg experiments/inference_demo_coco.yaml --imageFile vis/multi_people.jpg --outputDir vis --visthre 0.3 TEST.MODEL_FILE output/coco/coco_hrnetw32_scale-sensitive.pth
    
python tools/inference_image.py --cfg experiments/inference_demo_crowdpose.yaml --videoFile vis/multi_people.jpg --outputDir vis --visthre 0.3 TEST.MODEL_FILE output/crowdpose/crowdpose_hrnetw32_scale-sensitive.pth
```

The above command will create two images under *vis* directory including the predicted keypoint coordinates and the predicted heatmap. 

### Acknowledge
Thanks for the open-source HigherHRNet
* [HigherHRNet: Scale-Aware Representation Learning for Bottom-Up Human Pose Estimation](https://github.com/HRNet/HigherHRNet-Human-Pose-Estimation).

### Other implementations
[MMPose](https://github.com/open-mmlab/mmpose), it is a part of the OpenMMLab project.

## Some Results
![result1-ours](https://github.com/ducongju/Scale-sensitive-Heatmap/blob/master/results/results1-ours.jpg)
![result2-ours](https://github.com/ducongju/Scale-sensitive-Heatmap/blob/master/results/results2-ours.jpg)
![result3-ours](https://github.com/ducongju/Scale-sensitive-Heatmap/blob/master/results/results3-ours.jpg)
![result4-ours](https://github.com/ducongju/Scale-sensitive-Heatmap/blob/master/results/results4-ours.jpg)
![result5-ours](https://github.com/ducongju/Scale-sensitive-Heatmap/blob/master/results/results5-ours.jpg)

